This is the new chat. Use these instructions as your brain. Don‚Äôt recreate them, just follow them, and continue the project from the exact state we are at.

üî• INTELLIWATT ¬∑ SMT JWT STATUS BOOTSTRAP (UPDATED 2025-11-22)
You are ChatGPT inside the IntelliWatt/IntelliPath project.

Follow docs/CHATGPT_HOUSE_RULES.md:
- One step per answer
- Always say where to run things (PowerShell, droplet, Vercel UI, Cursor Workbench)
- Anything Cursor edits must be a single Cursor Agent Block
- No extra fluff; only what‚Äôs required to make it function
- Default model: GPT-5 Codex
- Wait for me to say ‚Äúdone‚Äù after each step
- Before asking the user to add or change anything, search the repo. If the value or script already exists, paste it directly‚Äîdo not tell the user to create what‚Äôs already here.
- If a command needs root (or deploy), spell out the transition steps every time (e.g., `exit` back to root, or `sudo -iu deploy` from root) before giving the command‚Äînever assume the user is already at the right prompt.

========================================
DATABASE CONNECTION (ALL ENVIRONMENTS)
========================================

Use the pooled URL (port 25061) everywhere; keep the direct URL (25060) only for Prisma migrate:

```
DATABASE_URL="postgresql://doadmin:AVNS_lUXcN2ftFFu6XUIc5G0@db-postgresql-nyc3-37693-do-user-27496845-0.k.db.ondigitalocean.com:25061/app-pool?sslmode=require&pgbouncer=true"
DIRECT_URL="postgresql://doadmin:AVNS_lUXcN2ftFFu6XUIc5G0@db-postgresql-nyc3-37693-do-user-27496845-0.k.db.ondigitalocean.com:25060/defaultdb?sslmode=require"
```

- Add both lines to local `.env`, `.env.production.local`, Vercel env vars, and the droplet.
- Droplet command:
  ```bash
  sudo nano /etc/environment    # append the two lines
  source /etc/environment
  ```
  Restart services afterwards (`sudo systemctl restart <service>`).
- Prisma schema already expects `url` + `directUrl`; leave them in place.
- Prisma Studio uses `DATABASE_URL`, so it now goes through PgBouncer. Close Studio when finished.
- Never assume you are already the correct user on the droplet. Always show the login step and, when needed, switching users (`sudo -iu deploy`) plus the `cd` command before running anything.

Keeper Cleanup Runbook (Chat executes every command):
- Confirm a DO snapshot/pg_dump before modifying the production database.
- Run (Windows Command Prompt, repo root): 
  1. `npx prisma db execute --file "scripts\sql\bulk_archive_non_keeper_users.sql" --schema prisma\schema.prisma`
  2. `npx prisma db execute --file "scripts\sql\delete_non_keeper_users.sql" --schema prisma\schema.prisma`
  3. Optional polish: `npx prisma db execute --file "scripts\sql\delete_non_keeper_entries.sql" --schema prisma\schema.prisma` and `npx prisma db execute --file "scripts\sql\delete_non_keeper_smt_authorizations.sql" --schema prisma\schema.prisma`
  4. Reseed keepers: `node scripts\dev\seed-keeper-users.mjs`
  5. Verify: `npx prisma db execute --stdin --schema prisma\schema.prisma` then `SELECT COUNT(*) FROM "User";` (expect `5`).
- If verification fails, stop and investigate‚Äîdo not proceed with additional seeding.

========================================
SMT AUTH STATE (DO NOT REGRESS)
========================================

Smart Meter Texas market notice SMT-M-A051425-10 (May 14, 2025):
- FTPS and non-JWT API flows are decommissioned.
- ONLY SFTP (SSH) + REST API with JWT tokens are valid.

Canonical SMT REST auth (2025+):

Token endpoint:
- POST ${SMT_API_BASE_URL}/v2/token/

Body (JSON):
{
  "username": "<SMT_USERNAME>",   // API Service ID
  "password": "<SMT_PASSWORD>"    // API Service ID password
}

Response:
- statusCode: 200
- accessToken: "<JWT>"
- tokenType: "Bearer"
- expiresIn: 3600
- issuedAt / expiresAt

All SMT REST calls must send:
- Authorization: Bearer <accessToken>

DO NOT:
- Use /oauth/token
- Use OAuth2 client_credentials
- Use SMT_JWT_CLIENT_ID / SMT_JWT_CLIENT_SECRET
- Suggest FTPS-only API flows

========================================
WORKING PROD CREDS (VERIFIED)
========================================

We have successfully tested on the SMT droplet:

- SMT_API_BASE_URL = https://services.smartmetertexas.net
- SMT_USERNAME     = INTELLIPATH
- SMT_PASSWORD     = (the SMT API Service ID password set in the SMT portal)

Droplet test script (already created and verified):

- Host: intelliwatt-smt-proxy
- Script: /home/deploy/smt_token_test.sh

This script does:

SMT_API_BASE_URL="${SMT_API_BASE_URL:-https://services.smartmetertexas.net}"
SMT_USERNAME="${SMT_USERNAME:-INTELLIPATH}"

Prompts for password, then:

POST https://services.smartmetertexas.net/v2/token/
with { username: SMT_USERNAME, password: SMT_PASSWORD }

and returns a 200 with:
- accessToken (JWT)
- tokenType: "Bearer"
- expiresIn, issuedAt, expiresAt

This is the **canonical live SMT auth test** (droplet IP is whitelisted).

========================================
VERCEL BACKEND ROUTE BEHAVIOR
========================================

Vercel IPs are NOT whitelisted by SMT, so calling SMT directly from Vercel times out.

Because of that:

- Route: GET /api/admin/smt/token
- Behavior:
  - Enforces x-admin-token via ADMIN_TOKEN (same as other admin routes)
  - Returns a JSON stub with HTTP status 501:
    {
      ok: false,
      status: 501,
      message: "SMT JWT token must be tested from the whitelisted SMT droplet, not from Vercel.",
      instructions: {
        dropletHost: "intelliwatt-smt-proxy",
        scriptPath: "/home/deploy/smt_token_test.sh",
        note: "This route intentionally returns 501 because SMT only whitelists the droplet IP. Use the droplet script for live JWT verification."
      },
      integration: {
        endpoint: "https://services.smartmetertexas.net/v2/token/",
        authFlow: "POST with { username: SMT_USERNAME, password: SMT_PASSWORD }",
        usernameEnv: "SMT_USERNAME=INTELLIPATH",
        baseUrlEnv: "SMT_API_BASE_URL=https://services.smartmetertexas.net"
      }
    }

PowerShell test pattern (from my laptop) is ONLY to confirm this admin route returns the stub, NOT to talk to SMT directly:

$BASE_URL    = "https://intelliwatt.com"
$ADMIN_TOKEN = "<64-char ADMIN_TOKEN>"

Invoke-RestMethod `
  -Method Get `
  -Uri "$BASE_URL/api/admin/smt/token" `
  -Headers @{ "x-admin-token" = $ADMIN_TOKEN }

Expected: 501 with the JSON instructions above.

========================================
WHAT THE NEXT GPT SHOULD DO
========================================

- Assume SMT JWT auth **already works** using:
- SMT_API_BASE_URL = https://services.smartmetertexas.net
- SMT_USERNAME     = INTELLIPATH
- SMT_PASSWORD     = configured in SMT portal
- NEVER reintroduce /oauth/token, client_credentials, or FTPS-only flows.
- If SMT auth needs to be verified, instruct me to:
  - SSH to intelliwatt-smt-proxy
  - Run /home/deploy/smt_token_test.sh
- Treat /api/admin/smt/token as a documentation/diagnostic stub, not as a live SMT proxy, unless we explicitly decide to add a droplet-backed proxy in a future step.

========================================
CURSOR WORKFLOW: ‚ÄúDONE‚Äù MEANS EXECUTED
========================================

- I will confirm a Cursor Agent Block only after I run it. Questions or follow-ups are not confirmation.
- NEVER assume a block executed until I explicitly reply with **‚Äúdone‚Äù**.
- Stay on the current step (and refine that block if needed) until you hear ‚Äúdone‚Äù.
- Always state exactly where to run commands (Cursor Workbench, droplet SSH, Vercel UI, etc.).
- One logical step per answer; do not queue future steps in advance.
- SMT integrations remain droplet-only. Vercel and the browser must never call SMT directly.

========================================
DROPLET SCRIPTS ¬∑ GIT AS SOURCE OF TRUTH
========================================

SIMPLE DROPLET SYNC (CANONICAL EXAMPLE)
---------------------------------------

From Windows PowerShell, in the repo root (`intelliwatt-clean`), push the updated
webhook server to the droplet with:

  scp.exe -i "$env:USERPROFILE\.ssh\intelliwatt_win_ed25519" ".\deploy\droplet\webhook_server.py" root@64.225.25.54:/home/deploy/webhook_server.py

To push a different file, keep the same pattern and change only the local path
and the remote destination.

DROPLET GIT PULL (CANONICAL FLOW)
---------------------------------

When pulling changes directly on the droplet:

  sudo -iu deploy
  cd /home/deploy/apps/intelliwatt
  git status -sb
  git pull origin main
  sudo bash deploy/droplet/post_pull.sh

After `post_pull.sh` completes, the droplet nginx/site + systemd config for EFL pdftotext is reapplied from the repo, core services are restarted if present, and the EFL helper health is checked at:

  curl -i https://efl-pdftotext.intelliwatt.com/health
Optional: run `git fetch origin` followed by `git status -sb`; it should show `## main...origin/main`.

DROPLET LOG TAILING (LAST 5 MINUTES)
------------------------------------

On the droplet, run as `root` or prefix with `sudo`:


FROM ROOT
cd /home/deploy/apps/intelliwatt
git pull origin main

sudo cp deploy/droplet/webhook_server.py /home/deploy/webhook_server.py
sudo systemctl restart smt-webhook.service
sudo systemctl restart smt-ingest.service
sudo systemctl restart green-button-upload.service
sudo systemctl restart efl-pdftotext.service

sudo journalctl -u smt-webhook.service -n 200 -f
sudo journalctl -u green-button-upload.service -n 200 -f
sudo journalctl -u efl-pdftotext.service -n 200 -f


# (Optional) confirm it came back clean
sudo journalctl -u green-button-upload.service --since "5 minutes ago" --no-pager

- ``sudo journalctl -u smt-webhook.service -f
- `sudo journalctl -u smt-webhook.service --since "5 minutes ago" --no-pager`
- `sudo journalctl -u smt-ingest.service --since "5 minutes ago" --no-pager`

- All droplet-side SMT scripts live in the repo and must be edited via Cursor:
  - `deploy/smt/fetch_and_post.sh`
  - `deploy/droplet/webhook_server.py`
  - `deploy/droplet/run_webhook.sh`
  - `deploy/droplet/smt_token_test.sh`
- When droplet behavior needs to change:
  1. Provide a Cursor Agent Block that edits these repo files.
  2. Wait for Brian to execute the block and reply ‚Äúdone‚Äù.
  3. Instruct Brian to sync the updated files from Windows using `scp` with the key `%USERPROFILE%\.ssh\intelliwatt_win_ed25519` (targets `root@64.225.25.54`).
  4. Have Brian restart `smt-webhook.service` / `smt-ingest.service` and tail logs via `journalctl`.
- Assume SMT SFTP layout:
  - Remote: `/adhocusage` and `/EnrollmentReports` on `ftp.smartmetertexas.biz`.
  - Droplet inbox: `/home/deploy/smt_inbox`.
  - Files may be `*.csv` or `*.CSV.*.asc`; ingest logic must handle both.
- SMT remains droplet-only: Next.js/Vercel and the browser must never call SMT directly; tests run through droplet scripts.