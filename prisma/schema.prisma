generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String             @id @default(cuid())
  email          String             @unique
  createdAt      DateTime           @default(now())
  referredById   String?
  commissions    CommissionRecord[]
  entries        Entry[]            @relation("UserEntries")
  jackpotPayouts JackpotPayout[]
  referrals      Referral[]         @relation("UserReferrals")
  sessions       Session[]
  usage          UsageData[]
  profile        UserProfile?
  utilityPlans   UtilityPlan[]
}

model UserProfile {
  id                      String          @id @default(cuid())
  userId                  String          @unique
  fullName                String?
  phone                   String?
  address                 String?
  zipCode                 String?
  homeSqFt                Int?
  homeAge                 Int?
  numStories              Int?
  numBedrooms             Int?
  numBathrooms            Int?
  wallMaterial            String?
  foundationType          String?
  insulationType          String?
  windowType              String?
  windowSealing           String?
  roofDirection           String?
  ledLighting             Boolean?
  smartThermostat         Boolean?
  thermostatType          String?
  summerTemp              Int?
  winterTemp              Int?
  heatingType             String?
  hvacType                String?
  waterHeaterType         String?
  pool                    Boolean?
  poolPumpType            String?
  evChargerType           String?
  evMilesPerDay           Int?
  numOccupants            Int?
  numStayHome             Int?
  numWorkOrSchool         Int?
  numFridges              Int?
  lightingType            String?
  applianceImagesUploaded Boolean?
  unusualTravelDates      String?
  hasSolar                Boolean?
  hasBattery              Boolean?
  plansToAddSolar         Boolean?
  plansToAddBattery       Boolean?
  createdAt               DateTime        @default(now())
  addressCity             String?
  addressLine1            String?
  addressState            String?
  addressValidated        Boolean?
  addressZip              String?
  esiid                   String?
  smartMeterConsent       Boolean?
  smartMeterConsentDate   DateTime?
  tdspSlug                String?
  apiConnections          ApiConnection[]
  appliances              Appliance[]
  solarSystem             SolarSystem?
  user                    User            @relation(fields: [userId], references: [id])
}

model Appliance {
  id         String      @id @default(cuid())
  profileId  String
  type       String
  brand      String?
  model      String?
  year       Int?
  energyStar Boolean?
  dailyKWh   Float?
  photoUrl   String?
  vin        String?
  schedule   String?
  createdAt  DateTime    @default(now())
  profile    UserProfile @relation(fields: [profileId], references: [id])
}

model ApiConnection {
  id          String      @id @default(cuid())
  profileId   String
  provider    String
  isActive    Boolean
  connectedAt DateTime    @default(now())
  profile     UserProfile @relation(fields: [profileId], references: [id])
}

model SolarSystem {
  id              String      @id @default(cuid())
  profileId       String      @unique
  numPanels       Int?
  panelModel      String?
  panelWattage    Int?
  annualKWh       Float?
  azimuth         Int?
  tilt            Int?
  batteryModel    String?
  batteryCount    Int?
  batteryCapacity Float?
  exportRate      Float?
  netMetering     Boolean?
  createdAt       DateTime    @default(now())
  profile         UserProfile @relation(fields: [profileId], references: [id])
}

model UsageData {
  id        String   @id @default(cuid())
  userId    String
  source    String
  interval  String
  data      Json
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model UtilityPlan {
  id          String    @id @default(cuid())
  userId      String
  provider    String
  planName    String
  rateImport  Float
  rateExport  Float
  deliveryFee Float
  monthlyFee  Float
  expiration  DateTime?
  isCurrent   Boolean
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
}

model Referral {
  id            String   @id @default(cuid())
  referredById  String
  referredEmail String
  createdAt     DateTime @default(now())
  referredBy    User     @relation("UserReferrals", fields: [referredById], references: [id])
}

model Entry {
  id        String   @id @default(cuid())
  userId    String
  type      String
  amount    Int
  createdAt DateTime @default(now())
  user      User     @relation("UserEntries", fields: [userId], references: [id])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model MagicLinkToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
}

model FinanceRecord {
  id        String   @id @default(cuid())
  type      String
  source    String
  category  String
  amount    Float
  status    String
  date      DateTime
  note      String?
  createdAt DateTime @default(now())
}

model CommissionRecord {
  id        String   @id @default(cuid())
  userId    String
  leadEmail String?
  type      String
  amount    Float
  status    String
  earnedAt  DateTime
  note      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model JackpotPayout {
  id          String    @id @default(cuid())
  userId      String
  amount      Float
  drawingDate DateTime
  paid        Boolean   @default(false)
  paidDate    DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
}

model RateConfig {
  id                     String         @id @default(cuid())
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  key                    String         @unique
  supplierSlug           String
  supplierName           String?
  planId                 String?
  nameId                 String?
  planName               String?
  tdsp                   String?
  tdspSlug               String?
  termMonths             Int?
  rateType               String?
  isGreen                Boolean?
  greenPct               Float?
  eflUrl                 String?
  tosUrl                 String?
  yracUrl                String?
  baseMonthlyFeeCents    Int?
  tduDeliveryCentsPerKwh Float?
  centsPerKwhJson        Json?
  billCreditsJson        Json?
  touWindowsJson         Json?
  otherFeesJson          Json?
  notes                  String?
  checksum               String?        @unique
  eflHash                String?
  fetchedAt              DateTime?
  validFrom              DateTime?
  validTo                DateTime?
  isActive               Boolean        @default(true)
  mappings               OfferRateMap[]
}

model OfferRateMap {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  offerId      String     @unique
  rateKey      String
  supplierSlug String
  planId       String?
  nameId       String?
  tdspSlug     String?
  eflUrl       String?
  lastSeenAt   DateTime   @default(now())
  rateConfigId String
  rateConfig   RateConfig @relation(fields: [rateConfigId], references: [id], onDelete: Cascade)

  @@index([supplierSlug, planId])
  @@index([supplierSlug, nameId])
  @@index([tdspSlug])
}

model MasterPlan {
  id             String      @id @default(uuid())
  source         PlanSource
  offerId        String?     @unique
  supplierName   String
  supplierPuctNo String?
  tdsp           TdspCode
  planName       String
  /// * Normalized keys from planmaster/keys.ts (Step 61)
  nameId         String
  planId         String
  termMonths     Int
  cancelFeeCents Int?
  productType    ProductType
  minUsageKwh    Int?
  hasBillCredit  Boolean     @default(false)
  eflUrl         String?
  tosUrl         String?
  yracUrl        String?
  /// * Raw provider payload (WattBuy offer, or other source)
  docs           Json
  /// * Parsed/normalized rate model from EFL (populated in Step 64)
  rateModel      Json?
  effectiveAt    DateTime    @default(now())
  expiresAt      DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([tdsp, termMonths])
  @@index([supplierName, planName])
  @@index([nameId])
  @@index([planId])
  @@index([effectiveAt])
  @@index([expiresAt])
}

model TdspRateSnapshot {
  id          String    @id @default(uuid())
  tdsp        TdspCode
  sourceUrl   String
  payload     Json
  effectiveAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([tdsp, createdAt])
  @@index([effectiveAt])
}

model OfferAudit {
  id           String   @id @default(uuid())
  event        String
  planId       String
  supplierName String
  planName     String
  tdsp         String
  userKey      String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([planId])
  @@index([supplierName])
  @@index([tdsp])
  @@index([createdAt])
}

model FeatureFlag {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model SupplierControl {
  id             String   @id @default(uuid())
  supplierName   String
  isBlocked      Boolean  @default(false)
  rolloutPercent Int?
  notes          String?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  @@index([supplierName])
}

model HouseAddress {
  id                    String           @id @default(uuid())
  userId                String
  houseId               String?
  addressLine1          String
  addressLine2          String?
  addressCity           String
  addressState          String
  addressZip5           String
  addressZip4           String?
  addressCountry        String           @default("US")
  placeId               String?
  lat                   Float?
  lng                   Float?
  addressValidated      Boolean          @default(false)
  validationSource      ValidationSource @default(NONE)
  esiid                 String?          @unique
  tdspSlug              String?
  utilityName           String?
  utilityPhone          String?
  smartMeterConsent     Boolean          @default(false)
  smartMeterConsentDate DateTime?
  rawGoogleJson         Json?
  rawWattbuyJson        Json?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([placeId])
  @@index([addressState, addressZip5])
  @@index([esiid])
}

enum PlanSource {
  wattbuy
  manual
  tdsp_feed
}

enum ValidationSource {
  NONE
  GOOGLE
  USER
  OTHER
}

enum TdspCode {
  ONCOR
  CENTERPOINT
  AEP_NORTH
  AEP_CENTRAL
  TNMP
}

enum ProductType {
  fixed
  variable
  indexed
  tou
}

model RawSmtFile {
  id           BigInt    @id @default(autoincrement())
  filename     String
  size_bytes   Int
  sha256       String    @unique
  source       String?   @default("adhocusage")
  content_type String?   @default("application/octet-stream")
  storage_path String?
  content      Bytes?
  received_at  DateTime? @default(now())
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  @@map("raw_smt_files")
  @@index([sha256])
  @@index([created_at])
}

model SmtInterval {
  id        String   @id @default(cuid())
  esiid     String
  meter     String
  ts        DateTime   // UTC interval START (15-min)
  kwh       Decimal    @db.Decimal(10,5)
  filled    Boolean    @default(false) // true if synthesized by gap-fill
  source    String?                 // e.g., 'smt', 'gb', 'mixed'
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([esiid, meter, ts], name: "esiid_meter_ts")
  @@index([esiid, meter, ts], name: "esiid_meter_ts_idx")
}
