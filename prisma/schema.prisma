generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  createdAt         DateTime           @default(now())
  referredById      String?
  commissions       CommissionRecord[]
  entries           Entry[]            @relation("UserEntries")
  jackpotPayouts    JackpotPayout[]
  referrals         Referral[]         @relation("UserReferrals")
  sessions          Session[]
  usage             UsageData[]
  profile           UserProfile?
  utilityPlans      UtilityPlan[]
  smtAuthorizations SmtAuthorization[]
}

model UserProfile {
  id                      String          @id @default(cuid())
  userId                  String          @unique
  fullName                String?
  phone                   String?
  address                 String?
  zipCode                 String?
  homeSqFt                Int?
  homeAge                 Int?
  numStories              Int?
  numBedrooms             Int?
  numBathrooms            Int?
  wallMaterial            String?
  foundationType          String?
  insulationType          String?
  windowType              String?
  windowSealing           String?
  roofDirection           String?
  ledLighting             Boolean?
  smartThermostat         Boolean?
  thermostatType          String?
  summerTemp              Int?
  winterTemp              Int?
  heatingType             String?
  hvacType                String?
  waterHeaterType         String?
  pool                    Boolean?
  poolPumpType            String?
  evChargerType           String?
  evMilesPerDay           Int?
  numOccupants            Int?
  numStayHome             Int?
  numWorkOrSchool         Int?
  numFridges              Int?
  lightingType            String?
  applianceImagesUploaded Boolean?
  unusualTravelDates      String?
  hasSolar                Boolean?
  hasBattery              Boolean?
  plansToAddSolar         Boolean?
  plansToAddBattery       Boolean?
  createdAt               DateTime        @default(now())
  addressCity             String?
  addressLine1            String?
  addressState            String?
  addressValidated        Boolean?
  addressZip              String?
  esiid                   String?
  smartMeterConsent       Boolean?
  smartMeterConsentDate   DateTime?
  tdspSlug                String?
  esiidAttentionRequired  Boolean         @default(false)
  esiidAttentionCode      String?
  esiidAttentionAt        DateTime?
  apiConnections          ApiConnection[]
  appliances              Appliance[]
  solarSystem             SolarSystem?
  user                    User            @relation(fields: [userId], references: [id])
}

model Appliance {
  id         String      @id @default(cuid())
  profileId  String
  type       String
  brand      String?
  model      String?
  year       Int?
  energyStar Boolean?
  dailyKWh   Float?
  photoUrl   String?
  vin        String?
  schedule   String?
  createdAt  DateTime    @default(now())
  profile    UserProfile @relation(fields: [profileId], references: [id])
}

model ApiConnection {
  id          String      @id @default(cuid())
  profileId   String
  provider    String
  isActive    Boolean
  connectedAt DateTime    @default(now())
  profile     UserProfile @relation(fields: [profileId], references: [id])
}

model SolarSystem {
  id              String      @id @default(cuid())
  profileId       String      @unique
  numPanels       Int?
  panelModel      String?
  panelWattage    Int?
  annualKWh       Float?
  azimuth         Int?
  tilt            Int?
  batteryModel    String?
  batteryCount    Int?
  batteryCapacity Float?
  exportRate      Float?
  netMetering     Boolean?
  createdAt       DateTime    @default(now())
  profile         UserProfile @relation(fields: [profileId], references: [id])
}

model UsageData {
  id        String   @id @default(cuid())
  userId    String
  source    String
  interval  String
  data      Json
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model UtilityPlan {
  id          String    @id @default(cuid())
  userId      String
  provider    String
  planName    String
  rateImport  Float
  rateExport  Float
  deliveryFee Float
  monthlyFee  Float
  expiration  DateTime?
  isCurrent   Boolean
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
}

model Referral {
  id            String   @id @default(cuid())
  referredById  String
  referredEmail String
  createdAt     DateTime @default(now())
  referredBy    User     @relation("UserReferrals", fields: [referredById], references: [id])
}

model Entry {
  id        String   @id @default(cuid())
  userId    String
  type      String
  amount    Int
  createdAt DateTime @default(now())
  user      User     @relation("UserEntries", fields: [userId], references: [id])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model MagicLinkToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
}

model FinanceRecord {
  id        String   @id @default(cuid())
  type      String
  source    String
  category  String
  amount    Float
  status    String
  date      DateTime
  note      String?
  createdAt DateTime @default(now())
}

model CommissionRecord {
  id        String   @id @default(cuid())
  userId    String
  leadEmail String?
  type      String
  amount    Float
  status    String
  earnedAt  DateTime
  note      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model JackpotPayout {
  id          String    @id @default(cuid())
  userId      String
  amount      Float
  drawingDate DateTime
  paid        Boolean   @default(false)
  paidDate    DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
}

model RateConfig {
  id                     String         @id @default(cuid())
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  key                    String         @unique
  supplierSlug           String
  supplierName           String?
  planId                 String?
  nameId                 String?
  planName               String?
  tdsp                   String?
  tdspSlug               String?
  termMonths             Int?
  rateType               String?
  isGreen                Boolean?
  greenPct               Float?
  eflUrl                 String?
  tosUrl                 String?
  yracUrl                String?
  baseMonthlyFeeCents    Int?
  tduDeliveryCentsPerKwh Float?
  centsPerKwhJson        Json?
  billCreditsJson        Json?
  touWindowsJson         Json?
  otherFeesJson          Json?
  notes                  String?
  checksum               String?        @unique
  eflHash                String?
  fetchedAt              DateTime?
  validFrom              DateTime?
  validTo                DateTime?
  isActive               Boolean        @default(true)
  mappings               OfferRateMap[]
}

model OfferRateMap {
  id           String     @id @default(cuid())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  offerId      String     @unique
  rateKey      String
  supplierSlug String
  planId       String?
  nameId       String?
  tdspSlug     String?
  eflUrl       String?
  lastSeenAt   DateTime   @default(now())
  rateConfigId String
  rateConfig   RateConfig @relation(fields: [rateConfigId], references: [id], onDelete: Cascade)

  @@index([supplierSlug, planId])
  @@index([supplierSlug, nameId])
  @@index([tdspSlug])
}

model MasterPlan {
  id             String      @id @default(uuid())
  source         PlanSource
  offerId        String?     @unique
  supplierName   String
  supplierPuctNo String?
  tdsp           TdspCode
  planName       String
  /// * Normalized keys from planmaster/keys.ts (Step 61)
  nameId         String
  planId         String
  termMonths     Int
  cancelFeeCents Int?
  productType    ProductType
  minUsageKwh    Int?
  hasBillCredit  Boolean     @default(false)
  eflUrl         String?
  tosUrl         String?
  yracUrl        String?
  /// * Raw provider payload (WattBuy offer, or other source)
  docs           Json
  /// * Parsed/normalized rate model from EFL (populated in Step 64)
  rateModel      Json?
  effectiveAt    DateTime    @default(now())
  expiresAt      DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([tdsp, termMonths])
  @@index([supplierName, planName])
  @@index([nameId])
  @@index([planId])
  @@index([effectiveAt])
  @@index([expiresAt])
}

model TdspRateSnapshot {
  id          String    @id @default(uuid())
  tdsp        TdspCode
  sourceUrl   String
  payload     Json
  effectiveAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([tdsp, createdAt])
  @@index([effectiveAt])
}

model OfferAudit {
  id           String   @id @default(uuid())
  event        String
  planId       String
  supplierName String
  planName     String
  tdsp         String
  userKey      String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([planId])
  @@index([supplierName])
  @@index([tdsp])
  @@index([createdAt])
}

model FeatureFlag {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model SupplierControl {
  id             String   @id @default(uuid())
  supplierName   String
  isBlocked      Boolean  @default(false)
  rolloutPercent Int?
  notes          String?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  @@index([supplierName])
}

model HouseAddress {
  id                    String           @id @default(uuid())
  userId                String
  userEmail             String?
  houseId               String?
  addressLine1          String
  addressLine2          String?
  addressCity           String
  addressState          String
  addressZip5           String
  addressZip4           String?
  addressCountry        String           @default("US")
  placeId               String?
  lat                   Float?
  lng                   Float?
  addressValidated      Boolean          @default(false)
  validationSource      ValidationSource @default(NONE)
  esiid                 String?          @unique
  tdspSlug              String?
  utilityName           String?
  utilityPhone          String?
  smartMeterConsent     Boolean          @default(false)
  smartMeterConsentDate DateTime?
  rawGoogleJson         Json?
  rawWattbuyJson        Json?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  smtAuthorizations SmtAuthorization[]

  @@index([placeId])
  @@index([addressState, addressZip5])
  @@index([esiid])
  @@index([userEmail])
}

model RawSmtFile {
  id           BigInt    @id @default(autoincrement())
  filename     String
  size_bytes   Int
  sha256       String    @unique
  source       String?   @default("adhocusage")
  content_type String?   @default("application/octet-stream")
  storage_path String?
  content      Bytes?
  received_at  DateTime? @default(now())
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  billingReads SmtBillingRead[]

  @@index([sha256])
  @@index([created_at])
  @@map("raw_smt_files")
}

model SmtInterval {
  id        String   @id @default(cuid())
  esiid     String
  meter     String
  ts        DateTime
  kwh       Decimal  @db.Decimal(10, 5)
  filled    Boolean  @default(false)
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([esiid, meter, ts])
  @@index([esiid, meter, ts], map: "esiid_meter_ts_idx")
}

model SmtBillingRead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rawSmtFileId BigInt?
  rawSmtFile   RawSmtFile? @relation(fields: [rawSmtFileId], references: [id])

  esiid String
  meter String?

  tdspCode String?
  tdspName String?

  readStart DateTime?
  readEnd   DateTime?

  billDate DateTime?

  kwhTotal  Float?
  kwhBilled Float?

  source String?

  @@index([esiid, billDate])
  @@index([esiid, readStart])
  @@index([rawSmtFileId])
}

model SmtMeterInfo {
  id      String  @id @default(cuid())
  houseId String?
  esiid   String

  transId             String?
  meterNumber         String?
  utilityCompanyId    String?
  meterSerialNumber   String?
  utilityMeterId      String?
  kwhMeterMultiplier  Int?
  configuredChannels  String?
  manufacturerName    String?
  meterClass          String?
  intervalSetting     String?
  reverseFlowHandling String?
  dgChannel           String?
  disconnect          String?
  meterStatus         String?
  meterPhases         String?
  meterModel          String?

  testDate             String?
  installationDate     String?
  initialProvisionDate String?
  lastUpdatedRaw       String?

  communicationIndicator     String?
  instrumentRated            String?
  currentTransformersRatio   String?
  potentialTransformersRatio String?
  esiFirmwareVersion         String?
  hanProtocol                String?
  smartEnergyProfile         String?

  status       String  @default("pending")
  errorMessage String?
  rawPayload   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([esiid, houseId])
  @@index([esiid])
}

model SmtAuthorization {
  id String @id @default(cuid())

  userId         String
  houseId        String
  houseAddressId String

  esiid       String
  meterNumber String?

  customerName String

  serviceAddressLine1 String
  serviceAddressLine2 String?
  serviceCity         String
  serviceState        String
  serviceZip          String

  tdspCode String
  tdspName String

  authorizationStartDate DateTime
  authorizationEndDate   DateTime

  allowIntervalUsage     Boolean
  allowHistoricalBilling Boolean
  allowSubscription      Boolean

  contactEmail String
  contactPhone String?

  smtRequestorId     String
  smtRequestorAuthId String

  smtAgreementId         String?   @db.VarChar(100)
  smtSubscriptionId      String?   @db.VarChar(100)
  smtStatus              String?   @db.VarChar(50)
  smtStatusMessage       String?   @db.Text
  smtBackfillRequestedAt DateTime?
  smtBackfillCompletedAt DateTime?
  smtLastSyncAt          DateTime?

  consentTextVersion String? @db.VarChar(50)
  consentIp          String? @db.VarChar(64)
  consentUserAgent   String? @db.VarChar(255)

  user         User         @relation(fields: [userId], references: [id])
  houseAddress HouseAddress @relation(fields: [houseAddressId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([houseId])
  @@index([houseAddressId])
  @@index([esiid])
}

model PuctRep {
  id         String  @id @default(cuid())
  /// PUCT Retail Electric Provider certificate number, e.g. "10052"
  puctNumber String
  /// Legal company name as listed by PUCT, e.g. "JUST ENERGY TEXAS LP"
  legalName  String
  /// Doing-business-as / brand name (if present), e.g. "JUST ENERGY"
  dbaName    String?

  address1   String?
  address2   String?
  city       String?
  state      String?
  postalCode String?

  phone   String?
  website String?
  email   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([puctNumber, legalName])
  @@index([puctNumber])
  @@index([legalName])
  @@index([dbaName])
}

/// RatePlan - normalized electricity plans (REP plans and utility tariffs)
model RatePlan {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  externalId   String?
  utilityId    String
  state        String
  supplier     String?
  supplierPUCT String?
  planName     String?

  termMonths Int?
  rate500    Float?
  rate1000   Float?
  rate2000   Float?
  cancelFee  String?

  eflUrl  String?
  tosUrl  String?
  yracUrl String?

  isUtilityTariff Boolean   @default(false)
  tariffStructure Json?
  customerCharge  Float?
  minimumBill     Float?
  effectiveStart  DateTime?
  effectiveEnd    DateTime?
  sourceRateUrl   String?
  sourceParentUrl String?

  lastSeenAt DateTime @default(now())

  @@unique([utilityId, state, supplier, planName, termMonths, isUtilityTariff])
  @@index([utilityId, state, termMonths])
}

/// ERCOT Ingest - tracks ingestion history
model ErcotIngest {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  status      String // "ok" | "skipped" | "error"
  note        String? // freeform note (e.g., "daily", "manual test")
  fileUrl     String?
  fileSha256  String?  @unique
  tdsp        String? // oncor|centerpoint|aep_north|aep_central|tnmp|unknown
  rowCount    Int?
  headers     Json? // snapshot of response headers for drift
  error       String? // short error
  errorDetail String? // long stack
}

/// ERCOT ESIID Index - stores normalized ESIID data from ERCOT extracts
model ErcotEsiidIndex {
  id              BigInt   @id @default(autoincrement())
  esiid           String   @unique @db.VarChar(22)
  tdspCode        String?  @db.VarChar(16)
  serviceAddress1 String?
  serviceCity     String?  @db.VarChar(64)
  serviceState    String?  @db.Char(2)
  serviceZip      String?  @db.VarChar(10)
  status          String?  @db.VarChar(16)
  premiseType     String?  @db.VarChar(32)
  postedAtUtc     DateTime @db.Timestamptz(6)
  normLine1       String?
  normCity        String?  @db.VarChar(64)
  normZip         String?  @db.VarChar(10)

  @@index([normZip])
  @@index([normLine1(ops: raw("gin_trgm_ops"))], map: "ercot_esiid_index_normline1_trgm", type: Gin)
}

enum PlanSource {
  wattbuy
  manual
  tdsp_feed
}

enum ValidationSource {
  NONE
  GOOGLE
  USER
  OTHER
}

enum TdspCode {
  ONCOR
  CENTERPOINT
  AEP_NORTH
  AEP_CENTRAL
  TNMP
}

enum ProductType {
  fixed
  variable
  indexed
  tou
}
