/// NOTE: This schema is dedicated to the Usage module.
/// - Uses its own migrations directory: prisma/usage/migrations
/// - Points at USAGE_DATABASE_URL for its datasource.
/// - Generate/run Prisma commands with:
///     --schema=prisma/usage/schema.prisma
///     --migrations-dir=prisma/usage/migrations

generator usageClient {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  output        = "../../.prisma/usage-client"
}

datasource usageDb {
  provider = "postgresql"
  url      = env("USAGE_DATABASE_URL")
  directUrl = env("USAGE_DIRECT_URL")
}

enum DayType {
  ALL
  WEEKDAY
  WEEKEND
}

enum Season {
  ALL
  SUMMER
  WINTER
  SHOULDER
}

enum OvernightAttribution {
  ACTUAL_DAY
  START_DAY
}

model UsageModuleBootstrap {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
}

model UsageIntervalModule {
  id        String   @id @default(cuid())
  esiid     String
  meter     String
  ts        DateTime
  kwh       Decimal  @usageDb.Decimal(10, 5)
  filled    Boolean  @default(false)
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([esiid, meter, ts])
  @@index([ts])
  @@index([esiid, meter, ts])
}

model RawGreenButton {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  homeId String?
  userId String?

  utilityName   String?
  accountNumber String?

  filename  String
  mimeType  String
  sizeBytes Int
  content   Bytes

  sha256     String?   @unique
  capturedAt DateTime?

  @@index([homeId])
  @@index([userId])
}

model GreenButtonInterval {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  rawId           String
  homeId          String?
  userId          String?
  timestamp       DateTime
  consumptionKwh  Decimal  @usageDb.Decimal(10, 5)
  intervalMinutes Int      @default(15)

  @@index([rawId])
  @@index([timestamp])
  @@index([rawId, timestamp])
  @@index([homeId, timestamp])
}

model UsageBucketDefinition {
  id        String   @id @default(cuid())
  key       String   @unique // canonical key: kwh.m.<dayType>.<start>-<end>[.<season>]
  label     String
  dayType   DayType
  season    Season?
  startHHMM String
  endHHMM   String
  tz        String
  overnightAttribution OvernightAttribution @default(ACTUAL_DAY)
  ruleJson  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  monthly HomeMonthlyUsageBucket[]
  daily   HomeDailyUsageBucket[]

  @@index([dayType])
}

model HomeMonthlyUsageBucket {
  id         String   @id @default(cuid())
  homeId     String
  yearMonth  String // "YYYY-MM"
  bucketKey  String // FK by key (string) to keep lookups stable across environments
  kwhTotal   Decimal  @usageDb.Decimal(12, 6)
  source     String
  computedAt DateTime @default(now())

  bucket UsageBucketDefinition @relation(fields: [bucketKey], references: [key], onDelete: Restrict, onUpdate: Cascade)

  @@unique([homeId, yearMonth, bucketKey])
  @@index([homeId, yearMonth])
  @@index([bucketKey])
}

model HomeDailyUsageBucket {
  id        String   @id @default(cuid())
  homeId    String
  day       String // "YYYY-MM-DD" (America/Chicago local date)
  bucketKey String // references UsageBucketDefinition.key
  kwhTotal  Decimal  @usageDb.Decimal(12, 6)
  source    String
  computedAt DateTime @default(now())

  bucket UsageBucketDefinition @relation(fields: [bucketKey], references: [key], onDelete: Restrict, onUpdate: Cascade)

  @@unique([homeId, day, bucketKey])
  @@index([homeId, day])
  @@index([bucketKey])
}
