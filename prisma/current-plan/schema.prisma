/// NOTE: This schema uses its own migrations directory:
///   prisma/current-plan/migrations
///
/// IMPORTANT: Prisma CLI does not support selecting a custom migrations directory for
/// `prisma migrate deploy`. In this repo layout, `prisma migrate deploy --schema prisma/current-plan/schema.prisma`
/// will still scan `prisma/migrations` (not `prisma/current-plan/migrations`).
///
/// For production/staging ops, apply the SQL files in `prisma/current-plan/migrations/*/migration.sql`
/// using `prisma db execute` (or run a dedicated ops script).
generator currentPlanClient {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
  output        = "../../.prisma/current-plan-client"
}

datasource currentPlanDb {
  provider = "postgresql"
  url      = env("CURRENT_PLAN_DATABASE_URL")
}

enum CurrentPlanRateType {
  FIXED
  VARIABLE
  TIME_OF_USE
  OTHER
}

model CurrentPlanManualEntry {
  id                 String               @id @default(cuid())
  userId             String
  houseId            String?
  providerName       String
  planName           String
  rateType           CurrentPlanRateType
  energyRateCents    Decimal?             @currentPlanDb.Decimal(8, 4)
  baseMonthlyFee     Decimal?             @currentPlanDb.Decimal(8, 2)
  billCreditDollars  Decimal?             @currentPlanDb.Decimal(8, 2)
  termLengthMonths   Int?
  contractEndDate    DateTime?
  earlyTerminationFee Decimal?            @currentPlanDb.Decimal(8, 2)
  esiId              String?
  accountNumberLast4 String?
  notes              String?              @currentPlanDb.Text
  rateStructure      Json?
  normalizedAt       DateTime?
  lastConfirmedAt    DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  @@index([userId])
  @@index([userId, houseId])
}

model CurrentPlanBillUpload {
  id         String   @id @default(cuid())
  userId     String
  houseId    String?
  filename   String
  mimeType   String
  sizeBytes  Int
  billData   Bytes
  uploadedAt DateTime @default(now())

  parsedPlans ParsedCurrentPlan[] @relation("BillUploadToParsedPlans")

  @@index([userId])
  @@index([userId, houseId])
}

/// ParsedCurrentPlan stores structured fields extracted from an uploaded bill.
/// This is kept separate from manual entries so we can compare and merge later.
model ParsedCurrentPlan {
  id                  String               @id @default(cuid())
  userId              String
  houseId             String?

  /// Legacy pointer used by initial v1 implementation (kept for compatibility).
  sourceUploadId      String?

  /// New FK field to the uploaded bill that was parsed.
  uploadId            String?

  // Raw bill text snippet for debugging / re-parsing (not used directly by calculators)
  rawText             String?              @currentPlanDb.Text
  rawTextSnippet      String?              @currentPlanDb.Text

  // Identification / account
  esiid               String?
  meterNumber         String?
  providerName        String?
  tdspName            String?
  accountNumber       String?
  esiId               String?
  accountNumberLast4  String?

  // Customer + address
  customerName           String?
  serviceAddressLine1    String?
  serviceAddressLine2    String?
  serviceAddressCity     String?
  serviceAddressState    String?
  serviceAddressZip      String?

  // Plan type + contract
  rateType               CurrentPlanRateType?
  variableIndexType      String?
  planName               String?
  termMonths             Int?
  termLengthMonths       Int?
  contractStartDate      DateTime?
  contractEndDate        DateTime?
  earlyTerminationFeeCents Int?
  earlyTerminationFee    Decimal?             @currentPlanDb.Decimal(8, 2)

  // Prices (non-TOU)
  baseChargeCentsPerMonth Int?
  energyRateCents         Decimal?            @currentPlanDb.Decimal(8, 4)
  baseMonthlyFee          Decimal?            @currentPlanDb.Decimal(8, 2)
  billCreditDollars       Decimal?            @currentPlanDb.Decimal(8, 2)

  // Serialized JSON blobs for tiered rates, TOU windows, bill credits.
  // These are parsed into typed structures in application code, NOT used
  // directly by the DB for logic.
  energyRateTiersJson    Json?
  timeOfUseConfigJson    Json?
  billCreditsJson        Json?
  rateStructure          Json?

  // Optional billing-cycle meta
  billingPeriodStart     DateTime?
  billingPeriodEnd       DateTime?
  billIssueDate          DateTime?
  billDueDate            DateTime?
  totalAmountDueCents    Int?

  // Parser metadata
  parserVersion       String?
  confidenceScore     Float?

  // Relations
  billUpload          CurrentPlanBillUpload? @relation("BillUploadToParsedPlans", fields: [uploadId], references: [id])

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([userId])
  @@index([userId, houseId])
}

model BillPlanTemplate {
  id                      String   @id @default(cuid())
  providerNameKey         String   // normalized key, e.g. uppercased providerName
  planNameKey             String   // normalized key, e.g. uppercased planName

  // Core contract-level fields we want to reuse across bills for the same plan
  providerName            String?
  planName                String?
  rateType                String?  // 'FIXED' | 'VARIABLE' | 'TIME_OF_USE' | 'OTHER'
  variableIndexType       String?
  termMonths              Int?
  contractEndDate         DateTime?
  earlyTerminationFeeCents Int?
  baseChargeCentsPerMonth Int?

  energyRateTiersJson     Json?    // mirrors ParsedCurrentPlan.energyRateTiersJson
  timeOfUseConfigJson     Json?    // mirrors ParsedCurrentPlan.timeOfUseConfigJson
  billCreditsJson         Json?    // mirrors ParsedCurrentPlan.billCreditsJson

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([providerNameKey, planNameKey])
}

